<br>
<div class="container">
	<h6 class="slim-pagetitle">
		<span class="tx-mov">Payments</span>
	</h6>
</div>
<br>
<div class="container pl-0 pr-3 pb-0 pt-0">
	<fieldset>
		<form action="#" class="form-group" method="post">
			<div class="table-responsive table-transparent">
				<table id="blockTable" class="table table-bordered table-hover shadow" style="width:100%">
					<thead>
						<tr>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Coin</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Block Height</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Miners Paid</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Time</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Transaction</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Paid</span></th>
							<th class="vhmiddle tableHeaderStyle"><span class="tx-mov-mic">Status</span></th>
						</tr>
					</thead>
					<tbody id="blockTableBody"></tbody>
				</table>
			</div>
		</form>
	</fieldset>
</div>
<script>
	"{{ var totalPending = parseInt('0'); }}";
	"{{ var totalConfirmed = parseInt('0'); }}";
	"{{ var totalPaidOut = parseInt('0'); }}";
	var dataTable = $("#blockTable").DataTable({
		"bFilter": false,
		"bInfo" : false,
		"order": [[ 1, "desc" ]],
		"columnDefs": [
			{ "width": "100px", "targets": 0 },
			{ "width": "100px", "targets": 1 },
			{ "width": "50px", "targets": 2 },
			{ "width": "100px", "targets": 3 },
			{ "width": "100px", "targets": 4 },
			{ "width": "100px", "targets": 5 },
			{ "width": "50px", "targets": 6 }
		],
		"pageLength": 25,
		"pagingType": "full_numbers",
		"lengthMenu": [ 25, 50, 100, 150, 300, 500 ]
	});
	$("#coinSelect").ready(function() {
		updateTable("all", true);
	});
	$("#coinSelect").change(function() {
		updateTable(this.value, true);
	});
	function updateTable(value, updateText) {
		var options = {
			hour12: false, year: "numeric", month: "numeric",
			day: "numeric", hour: "2-digit", minute: "2-digit"
		};
		"{{ var sortedPools = Object.keys(it.stats.pools); }}";
		"{{ sortedPools.sort(function(a, b) { return a.workerCount - b.workerCount; }); }}";
		if(updateText && (dataTable.row)) {
			dataTable.clear().draw(true);
		}  
		"{{ for(i in sortedPools) { }}";
		"{{ var pool = sortedPools[i]; }}";
		if(updateText) {
			if (("all" !== value) && ("{{=pool}}" === value)) {
				"{{ var tmpPaid = parseFloat('{{=it.stats.pools[pool].poolStats.totalPaid}}').toFixed(8); }}";
				$('#tdHistoryPending').text("{{=it.stats.pools[pool].blocks.pending}}");
				$('#tdHistoryConfirmed').text("{{=it.stats.pools[pool].blocks.confirmed}}");
				$('#tdHistoryPaid').text("{{=tmpPaid}}");
			} else {
				"{{ var tmpPending = parseInt('{{=it.stats.pools[pool].blocks.pending}}'); }}";
				"{{ var tmpConfirmed = parseInt('{{=it.stats.pools[pool].blocks.confirmed}}'); }}";
				"{{ var tmpPaid = parseFloat('{{=it.stats.pools[pool].poolStats.totalPaid}}'); }}";
				"{{ var totalPending = parseInt(totalPending) + parseInt(tmpPending); }}";
				"{{ var totalConfirmed = parseInt(totalConfirmed) + parseInt(tmpConfirmed); }}";
				"{{ var totalPaidOut = parseFloat(totalPaidOut) + parseFloat(tmpPaid); }}";
			}
			"{{ for(p in it.stats.pools[pool].payments) { }}";
			"{{ var payment = it.stats.pools[pool].payments[p]; }}";
			if (("{{=pool}}" === value) || ("all" === value)) {
				dataTable.row.add([
					'<div class="vhmiddle"><span class="tableRowStyle"><img src="/static/icons/{{=it.stats.pools[pool].name}}.png" style="height: 24px;" /> <a class="text-black">{{=it.stats.pools[pool].name.charAt(0).toUpperCase() + it.stats.pools[pool].name.slice(1)}}</a></span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle text-black"><a href="{{=it.stats.pools[pool].explorerGetBlock + payment.blkid}}" target="_blank">{{=Math.max.apply(null, payment.blocks)}}</a></span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle text-black">{{=payment.miners}}</span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle text-black">' + new Date(parseInt("{{=payment.time}}")).toISOString().replace(/([^T]+)T([^\.]+).*/g, '$1 $2').toUpperCase() + '</span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle"><a href="{{=it.stats.pools[pool].explorerGetTX + payment.txid}}" target="_blank">{{=payment.txid.substring(0, 8) + ' &hellip; ' + payment.txid.substring(payment.txid.length - 8)}}</a></span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle text-black">{{=parseFloat(payment.paid).toFixed(4)}}</span></div>',
					'<div class="vhmiddle"><span class="tableRowStyle"><span class="badge badge-success"><span style="font-size: 13px;">Paid</span></span></span></div>',
				]).draw(true);
			}
			"{{ } }}";
		}
		"{{ } }}";  
		if ("all" === value) {
			var tmpOutVar = parseFloat("{{=totalPaidOut}}").toFixed(8);
			$('#tdHistoryPending').text("{{=totalPending}}");
			$('#tdHistoryConfirmed').text("{{=totalConfirmed}}");
			$('#tdHistoryPaid').text(tmpOutVar);
		}
	}
</script>